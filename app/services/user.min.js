"use strict";angular.module("app").service("User",["$rootScope","$q","$cookies","$api","MENUCONFIG",function(e,t,r,o,c){var n=this,a=/cloudenergy\.me/.test(location.hostname)?".cloudenergy.me":location.hostname;angular.extend(n,{data:void 0,account:function(r){var c=t.defer();return o.account.info(r||{},function(t){e.Account=t.result||{},c.resolve(e.Account)},c.reject),c.promise},project:function(){var r=t.defer();return o.project.info(function(t){e.Project=angular.isArray(t.result)?t.result:[t.result],e.Project.length?(localStorage.project_selected&&angular.forEach(e.Project,function(t){t._id===localStorage.project_selected&&(e.Project.selected=t)}),!e.Project.selected&&angular.forEach(e.Project,function(t){t._id===n.data.project&&(e.Project.selected=t)}),e.Project.selected=e.Project.selected||e.Project[0],localStorage.project_selected=e.Project.selected._id,r.resolve(e.Project)):r.reject()},r.reject),r.promise},userinfo:function(a){var u=t.defer();return o.business.userinfo(a||{},function(o){n.data=angular.extend(n.data||{},o.result||{}),e.client=r.get("client")||"WEB","WEB"===e.client?t.all([n.account({id:n.data.uid}),n.project()]).then(function(){angular.forEach(c,function(t){n.data.character.level<=t.character.level&&t.client[e.client]&&this.push(t)},e.sideMenu=[]),e.UserInfo=n.data,u.resolve(n.data)},u.reject):(e.UserInfo=n.data,u.resolve(n.data))},u.reject),u.promise},login:function(e){var c=t.defer();return o.auth.login(e||{},function(e){n.data=e.result,angular.forEach(["token","uid","user"],function(e){n.data[e]&&r.put(e,n.data[e]||!1,{path:"/",domain:a,expires:n.remember&&moment().add(1,"months")._d||void 0})}),n.userinfo().then(c.resolve,c.reject)},c.reject),c.promise},logout:function(c){var u=t.defer();return o.auth.logout(c||{},function(){delete e.Account,delete e.Project,delete e.UserInfo,delete n.data,angular.forEach(["token","uid","user"],function(e){r.remove(e,{path:"/",domain:".www"+a}),r.remove(e,{path:"/",domain:a}),r.remove(e,{path:"/"})}),u.resolve()},u.reject),u.promise}})}]);