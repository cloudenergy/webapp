"use strict";angular.module("app").service("User",["$rootScope","$q","$cookies","$api","MENUCONFIG",function(e,t,o,r,c){var n=this,a={},u=/cloudenergy\.me/.test(location.hostname)?".cloudenergy.me":location.hostname;e.User=n,angular.extend(n,{client:void 0,menu:void 0,data:void 0,account:void 0,project:void 0,$account:function(e){var o=t.defer();return r.account.info(e||{},function(e){o.resolve(n.account=e.result)},o.reject),o.promise},$project:function(){var e=t.defer();return r.project.info(function(t){n.project=angular.isArray(t.result)?t.result:[t.result],localStorage.project_selected&&angular.forEach(n.project,function(e){e._id===localStorage.project_selected&&(n.project.selected=e)}),!n.project.selected&&angular.forEach(n.project,function(e){e._id===a.project&&(n.project.selected=e)}),n.project.selected=n.project.selected||n.project[0],localStorage.project_selected=n.project.selected._id,e.resolve(n.project)},e.reject),e.promise},$userinfo:function(e){var u=t.defer();return r.business.userinfo(e||{},function(e){a=angular.extend(a,e.result),n.client=o.get("client")||"WEB","WEB"===n.client?t.all([n.$account({id:a.uid}),n.$project()]).then(function(){angular.forEach(c,function(e){a.character.level<=e.character.level&&e.client[n.client]&&this.push(e)},n.menu=[]),u.resolve(n.data=a)},function(e){delete n.account,delete n.project,u.reject(e)}):u.resolve(n.data=a)},u.reject),u.promise},$login:function(e){e=e||{};var c=t.defer(),l=e.remember;return delete e.remember,r.auth.login(e,function(e){a=e.result,angular.forEach(["token","uid","user"],function(e){a[e]&&o.put(e,a[e]||!1,{path:"/",domain:u,expires:l&&moment().add(1,"months")._d||void 0})}),n.$userinfo().then(c.resolve,c.reject)},c.reject),c.promise},$logout:function(e){var c=t.defer();return r.auth.logout(e||{},function(){delete n.menu,delete n.data,delete n.account,delete n.project,angular.forEach(["token","uid","user"],function(e){o.remove(e,{path:"/",domain:".www"+u}),o.remove(e,{path:"/",domain:u}),o.remove(e,{path:"/"})}),c.resolve()},c.reject),c.promise}})}]);