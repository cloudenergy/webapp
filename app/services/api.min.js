"use strict";angular.module("app").constant("APICONFIG",{auth:["auth",,{login:{},logout:{}}],account:["account",,{passwd:{},unbind:{url:"wxaccount/unbind"},wxbind:{url:"wxaccount/bind"}}],apptemplate:["apptemplate",,{info:{}}],business:["business",,{userinfo:{},recentchargelog:{},fundflow:{},monitor:{}}],device:["device",,{type:{}}],payment:["payment",,{channelinfo:{},charge:{}}],control:["control",,{send:{}}],department:["department",,{update:{}}],interaction:["interaction",,{uploadtoken:{}}],workorder:["workorder",,{add:{},info:{}}],qiniu:["qiniu",,{put:{url:location.origin+"/putb64/-1/key/:base64",transformRequest:function(e){return e.file},headers:{"Content-Type":"application/octet-stream",Authorization:function(e){if(e.params&&e.params.token){var t=e.params.token;return delete e.params.token,"UpToken "+t}}}}}]}).config(["$httpProvider",function(e){e.interceptors.push(["$rootScope","$q","$location","$timeout","$storage",function(e,t,n,r,a){function o(t,n){n?(angular.isObject(t.params)&&(t._inprogress=t.params._inprogress,delete t.params._inprogress),angular.isObject(t.data)&&angular.isUndefined(t._inprogress)&&(t._inprogress=t.data._inprogress,delete t.data._inprogress),t._inprogress!==!1&&(t._inprogress=r(function(){e.HttpInProgress++,t._inprogress=e.HttpInProgress},60))):(t._inprogress!==!1&&(angular.isNumber(t._inprogress)?r(function(){e.HttpInProgress--},60):angular.isObject(t._inprogress)&&r.cancel(t._inprogress)),delete t._inprogress)}return e.HttpInProgress=0,{request:function(e){return o(e,!0),/\/api\//.test(e.url)&&!/\/api\/auth\/(login|logout)/.test(e.url)&&(e.transformRequest=e.transformRequest.concat([function(e){return JSON.stringify(a.encrypt(JSON.parse(e||"{}")))}])),e},requestError:function(e){return t.reject(e)},response:function(e){return o(e.config,!1),angular.isObject(e.data)&&(e.data.code||angular.isObject(e.data.result)&&!Object.keys(e.data.result).length)?(/90000005|90000007/.test(e.data.code)&&n.url("/m/login").replace(),t.reject(e.data)):e},responseError:function(e){return o(e.config,!1),t.reject(e.data||{code:e.status})}}}])}]).service("$api",["$rootScope","$resource","APICONFIG",function(e,t,n){var r=function(e,t){return/(^http:\/\/)|(^https:\/\/)/.test(e)&&e||[!location.host||/^(pre(\w*)\.|localhost)/.test(location.host)?"https://preapi.cloudenergy.me":"https://api.cloudenergy.me","/api/"+e,t&&"/:_api_action"||""].join("")},a=[];e.$on("$stateChangeStart",function(){angular.forEach(a,function(e){!e.$resolved&&e.$cancelRequest()}),a=[]}),angular.forEach(n,function(e,n){angular.isArray(e)&&e[0]&&(e[0]=r(e[0],!!e[2]),e[3]=angular.extend({cancellable:!0},e[3]),angular.forEach(e[2],function(e,t){angular.extend(e,{url:e.url&&r(e.url)||void 0,method:e.method||"POST",params:angular.extend(e.url&&{}||{_api_action:t},e.params)})}),angular.forEach(this[n]=t.apply(t,e),function(e,t){this[t]=function(){var t,n;return angular.isObject(arguments[0])&&angular.isDefined(arguments[0]._cancellable)&&(n=arguments[0]._cancellable,delete arguments[0]._cancellable),angular.isObject(arguments[1])&&angular.isDefined(arguments[1]._cancellable)&&(n=arguments[1]._cancellable,delete arguments[1]._cancellable),t=e.apply(this,arguments),n===!1&&delete t.$cancelRequest,t.$cancelRequest&&a.push(t),t}},this[n]))},this)}]);