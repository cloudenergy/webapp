"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(e,a,t,r,o){var i,n,c=this;angular.extend(c,{list:function(t){return e.User.data?(i="UNREADMESSAGE_"+e.User.data.uid+"_"+e.User.data.project,o.message.list(angular.extend(t||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise):a.reject()},readed:function(e){return o.message.readed(e,function(){c.clearStorage(e)}).$promise},delete:function(e){return o.message.delete(e,function(){c.clearStorage(e)}).$promise},clearStorage:function(a){a.id&&(localStorage[i]=(localStorage[i]||"").replace(","+a.id+",",",").replace(","+a.id,"").replace(a.id+",","").replace(a.id,""),localStorage[i]||(a.all=!0)),a.all&&(delete e.UNREADMESSAGE,delete localStorage[i])},check:function(){c.list({unread:1,pagesize:60}).then(function(a){e.UNREADMESSAGE=a&&a.result&&a.result.detail||[];var o=localStorage[i]||"",c=o?o.split(","):[],l=[];angular.forEach(e.UNREADMESSAGE,function(e){!~c.indexOf(e.id)&&l.push(e.id)}),c=c.concat(l),localStorage[i]=c.join(),!n&&l.length&&(n=t.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(a){n=void 0,a&&("app.notification"===r.current.name?e.$broadcast("app.notification:refresh"):r.go("app.notification"))}))})}})}]);