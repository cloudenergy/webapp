"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(e,a,t,o,r){var i,n=this;angular.extend(n,{list:function(t){return e.User.data?r.message.list(angular.extend(t||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise:a.reject()},readed:function(e){return r.message.readed(e,function(){n.clearStorage(e)}).$promise},delete:function(e){return r.message.delete(e,function(){n.clearStorage(e)}).$promise},clearStorage:function(a){a.id&&(localStorage.UNREADMESSAGE.replace(","+a.id+",",","),localStorage.UNREADMESSAGE.replace(","+a.id,""),localStorage.UNREADMESSAGE.replace(a.id+",",""),localStorage.UNREADMESSAGE.replace(a.id,""),localStorage.UNREADMESSAGE||(a.all=!0)),a.all&&(delete e.UNREADMESSAGE,delete localStorage.UNREADMESSAGE)},check:function(){n.list({unread:1,pagesize:60}).then(function(a){e.UNREADMESSAGE=a&&a.result&&a.result.detail||[];var r=localStorage.UNREADMESSAGE||"",n=r?r.split(","):[],l=[];angular.forEach(e.UNREADMESSAGE,function(e){!~n.indexOf(e.id)&&l.push(e.id)}),n=n.concat(l),localStorage.UNREADMESSAGE=n.join(),!i&&l.length&&(i=t.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(a){i=void 0,a&&("app.notification"===o.current.name?e.$broadcast("app.notification:refresh"):o.go("app.notification"))}))})}})}]);