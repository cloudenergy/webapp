"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$stateParams","$api",function(e,t,a,r,o,i){var n,l=this;angular.extend(l,{list:function(a){return e.User.data?i.message.list(angular.extend(a||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise:t.reject()},readed:function(e){return i.message.readed(e,function(){l.clearStorage(e)}).$promise},delete:function(e){return i.message.delete(e,function(){l.clearStorage(e)}).$promise},clearStorage:function(t){t.id&&(localStorage.UNREADMESSAGE.replace(","+t.id+",",","),localStorage.UNREADMESSAGE.replace(","+t.id,""),localStorage.UNREADMESSAGE.replace(t.id+",",""),localStorage.UNREADMESSAGE.replace(t.id,""),localStorage.UNREADMESSAGE||(t.all=!0)),t.all&&(delete e.UNREADMESSAGE,delete localStorage.UNREADMESSAGE)},check:function(){l.list({unread:1,pagesize:60}).then(function(t){e.UNREADMESSAGE=t&&t.result&&t.result.detail||[];var i=localStorage.UNREADMESSAGE||"",l=i?i.split(","):[],c=[];angular.forEach(e.UNREADMESSAGE,function(e){!~l.indexOf(e.id)&&c.push(e.id)}),l=l.concat(c),localStorage.UNREADMESSAGE=l.join(),!n&&c.length&&(n=a.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(e){n=void 0,e&&("app.notification"===r.current.name?r.transitionTo(r.current,o,{reload:!0,inherit:!1,notify:!0}):r.go("app.notification"))}))})}})}]);