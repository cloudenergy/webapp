"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(e,a,t,o,r){var l,i=this;angular.extend(i,{list:function(t){return e.User.data?r.message.list(angular.extend(t||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise:a.reject()},readed:function(e){return r.message.readed(e,function(){i.clearStorage(e)}).$promise},delete:function(e){return r.message.delete(e,function(){i.clearStorage(e)}).$promise},clearStorage:function(a){a.id&&(localStorage.UNREADMESSAGE.replace(","+a.id+",",","),localStorage.UNREADMESSAGE.replace(","+a.id,""),localStorage.UNREADMESSAGE.replace(a.id+",",""),localStorage.UNREADMESSAGE.replace(a.id,""),localStorage.UNREADMESSAGE||(a.all=!0)),a.all&&(delete e.UNREADMESSAGE,delete localStorage.UNREADMESSAGE)},check:function(){i.list({unread:1,pagesize:60}).then(function(a){e.UNREADMESSAGE=a&&a.result&&a.result.detail||[];var r=localStorage.UNREADMESSAGE||"",i=r?r.split(","):[],n=[];angular.forEach(e.UNREADMESSAGE,function(e){!~i.indexOf(e.id)&&n.push(e.id)}),i=i.concat(n),localStorage.UNREADMESSAGE=i.join(),!l&&n.length&&(l=t.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(e){l=void 0,e&&o.go("app.notification")}))})}})}]);