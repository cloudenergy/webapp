"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(e,t,a,o,r){var i,n,c=this;angular.extend(c,{list:function(a){return c.setStorageKey(),e.User.data?r.message.list(angular.extend(a||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise:t.reject()},readed:function(e){return r.message.readed(e,function(){c.clearStorage(e)}).$promise},delete:function(e){return r.message.delete(e,function(){c.clearStorage(e)}).$promise},setStorageKey:function(){i="UNREADMESSAGE_"+e.User.data.uid+"_"+e.User.data.project},clearStorage:function(t){t.id&&(localStorage[i].replace(","+t.id+",",","),localStorage[i].replace(","+t.id,""),localStorage[i].replace(t.id+",",""),localStorage[i].replace(t.id,""),localStorage[i]||(t.all=!0)),t.all&&(delete e.UNREADMESSAGE,delete localStorage[i])},check:function(){c.setStorageKey(),c.list({unread:1,pagesize:60}).then(function(t){e.UNREADMESSAGE=t&&t.result&&t.result.detail||[];var r=localStorage[i]||"",c=r?r.split(","):[],l=[];angular.forEach(e.UNREADMESSAGE,function(e){!~c.indexOf(e.id)&&l.push(e.id)}),c=c.concat(l),localStorage[i]=c.join(),!n&&l.length&&(n=a.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(t){n=void 0,t&&("app.notification"===o.current.name?e.$broadcast("app.notification:refresh"):o.go("app.notification"))}))})}})}]);