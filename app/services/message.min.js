"use strict";angular.module("app").service("$message",["$rootScope","$q","$window","$ionicPopup","$state","$api",function(e,a,t,o,r,i){var l,n=this;angular.extend(n,{list:function(t){return e.User.data?i.message.list(angular.extend(t||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise:a.reject()},readed:function(e){return i.message.readed(e,function(){n.clearStorage(e)}).$promise},delete:function(e){return i.message.delete(e,function(){n.clearStorage(e)}).$promise},clearStorage:function(a){a.id&&(localStorage.UNREADMESSAGE.replace(","+a.id+",",","),localStorage.UNREADMESSAGE.replace(","+a.id,""),localStorage.UNREADMESSAGE.replace(a.id+",",""),localStorage.UNREADMESSAGE.replace(a.id,""),localStorage.UNREADMESSAGE||(a.all=!0)),a.all&&(delete e.UNREADMESSAGE,delete localStorage.UNREADMESSAGE)},check:function(){n.list({unread:1,pagesize:60}).then(function(a){e.UNREADMESSAGE=a&&a.result&&a.result.detail||[];var i=localStorage.UNREADMESSAGE||"",n=i?i.split(","):[],c=[];angular.forEach(e.UNREADMESSAGE,function(e){!~n.indexOf(e.id)&&c.push(e.id)}),n=n.concat(c),localStorage.UNREADMESSAGE=n.join(),!l&&c.length&&(l=o.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(e){l=void 0,e&&("app.notification"===r.current.name?t.location.reload():r.go("app.notification"))}))})}})}]);