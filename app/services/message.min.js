"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(o,t,i,n,a){var l,c,r=this;angular.extend(r,{list:function(e){return o.User.data?(l="UNREADMESSAGE_"+o.User.data.uid+"_"+o.User.data.project,a.message.list(angular.extend(e||{},{uid:o.User.data.uid,projectid:o.User.data.project})).$promise):t.reject()},readed:function(e){return a.message.readed(e,function(){r.clearStorage(e)}).$promise},delete:function(e){return a.message.delete(e,function(){r.clearStorage(e)}).$promise},clearStorage:function(e){e.id&&(localStorage[l]=(localStorage[l]||"").replace(","+e.id+",",",").replace(","+e.id,"").replace(e.id+",","").replace(e.id,""),localStorage[l]||(e.all=!0)),e.all&&(delete o.UNREADMESSAGE,delete localStorage[l])},check:function(){r.list({unread:1,pagesize:60}).then(function(e){o.UNREADMESSAGE=e&&e.result&&e.result.detail||[];var t=localStorage[l]||"",a=t?t.split(","):[],r=[];angular.forEach(o.UNREADMESSAGE,function(e){!~a.indexOf(e.id)&&r.push(e.id)}),(a=a.concat(r)).length?localStorage[l]=a.join():delete localStorage[l],!c&&r.length&&(c=i.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(e){c=void 0,e&&("app.notification"===n.current.name?o.$broadcast("app.notification:refresh"):n.go("app.notification"))}))})}})}]);