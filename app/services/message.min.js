"use strict";angular.module("app").service("$message",["$rootScope","$q","$ionicPopup","$state","$api",function(e,t,a,r,o){var i,n,l=this;angular.extend(l,{list:function(a){return e.User.data?(i="UNREADMESSAGE_"+e.User.data.uid+"_"+e.User.data.project,o.message.list(angular.extend(a||{},{uid:e.User.data.uid,projectid:e.User.data.project})).$promise):t.reject()},readed:function(e){return o.message.readed(e,function(){l.clearStorage(e)}).$promise},delete:function(e){return o.message.delete(e,function(){l.clearStorage(e)}).$promise},clearStorage:function(t){t.id&&(localStorage[i]=(localStorage[i]||"").replace(","+t.id+",",",").replace(","+t.id,"").replace(t.id+",","").replace(t.id,""),localStorage[i]||(t.all=!0)),t.all&&(delete e.UNREADMESSAGE,delete localStorage[i])},check:function(){l.list({unread:1,pagesize:60}).then(function(t){e.UNREADMESSAGE=t&&t.result&&t.result.detail||[];var o=localStorage[i]||"",l=o?o.split(","):[],c=[];angular.forEach(e.UNREADMESSAGE,function(e){!~l.indexOf(e.id)&&c.push(e.id)}),(l=l.concat(c)).length?localStorage[i]=l.join():delete localStorage[i],!n&&c.length&&(n=a.confirm({title:"通知提醒",template:"收到最新通知，是否立即查看？",cancelText:"稍后",okText:"查看"}).then(function(t){n=void 0,t&&("app.notification"===r.current.name?e.$broadcast("app.notification:refresh"):r.go("app.notification"))}))})}})}]);