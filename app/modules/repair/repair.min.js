"use strict";angular.module("app").controller("app.repair",["$scope","$timeout","$ionicModal","$api","User",function(e,t,a,i,n){var r=this,o={count:0,pageindex:0,pagesize:30};r.loadList=function(a){/refresher/.test(a)&&(o.count=0,o.pageindex=0),i.workorder.info({uid:n.data.uid,project:n.data.project,pageindex:o.pageindex+1,pagesize:o.pagesize},function(e){/refresher/.test(a)&&r.list&&(r.list.length=0),o=e.result.paging,angular.forEach(e.result.detail,function(e){this.push(e)},r.list=r.list||[])},function(){r.list?r.list.length=0:r.list=[]}).finally(function(){/refresher/.test(a)&&e.$broadcast("scroll.refreshComplete"),/infinite/.test(a)&&e.$broadcast("scroll.infiniteScrollComplete"),r.infiniteDisable=!0,r.list&&r.list.length<o.count&&t(function(){delete r.infiniteDisable},16.66)})},e.$on("$ionicView.enter",function(){a.fromTemplateUrl("app/modules/repair/detail.html?rev=b141d8e312",{scope:e,animation:"slide-in-up"}).then(function(e){r.modalDetail=e})}),e.$on("$ionicView.leave",function(){r.modalDetail&&r.modalDetail.remove()})}]).component("repairDetail",{templateUrl:"app/modules/repair/detail.html?rev=b141d8e312",controller:["$api","User","$stateParams",function(e,t,a){var i=this;angular.extend(i,{$onInit:function(){e.workorder.info({id:a.id,project:t.data.project},function(e){i.data=e.result.content})}})}]}).component("repairAdd",{templateUrl:"app/modules/repair/detail.html?rev=b141d8e312",controller:["$api","User","$state","$q","FileUploader","base64",function(e,t,a,i,n,r){var o=this;angular.extend(o,{$onInit:function(){o.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},o.submitted=!1,o.uploader=new n,o.uploader.queueLimit=3},removeItem:function(e){o.uploader.removeFromQueue(e)},submit:function(n){o.submitted=!0;var l=[];angular.forEach(o.uploader.queue,function(t){var a=(new Date).getTime()+"_"+t._file.name,n=i.defer();l.push(n.promise),o.data.repairImgs.push(a),e.interaction.uploadtoken({file:a},function(a){e.qiniu.put({base64:r.encode(a.result.file),token:a.result.token},{file:t.formData[0]},n.resolve,n.reject)},n.reject)}),i.all(l).then(function(){e.workorder.add({from:t.data.uid,content:o.data,project:t.data.project,type:1081},function(){Dialog.alert({title:"提交成功！",targrtEvent:n}),a.go("app.repair")},function(e){Dialog.alert({title:"提交失败！",textContent:e.message||void 0,targrtEvent:n})})},function(){Dialog.alert({title:"上传失败，请稍后再试",targrtEvent:n}),o.submitted=!1})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.helper={support:!(!e.FileReader||!e.CanvasRenderingContext2D),isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(t)}},a.helper.isFile(a.imgItem._file)&&a.helper.isImage(a.imgItem._file)&&(a.canvas=t.find("canvas"),a.reader=new FileReader,a.reader.onload=a.onLoadFile,a.reader.readAsDataURL(a.imgItem._file))},onLoadFile:function(e){a.img=new Image,a.img.onload=a.onLoadImage,a.img.src=e.target.result},onLoadImage:function(){a.compressedImg();var e=document.documentElement.clientWidth,t=.3*e>200?200:.3*e,i=t;a.canvas.attr({width:t,height:i}),a.canvas[0].getContext("2d").drawImage(this,0,0,t,i)},compressedImg:function(){var e;a.canvas.attr({width:1024,height:768}),a.canvas[0].getContext("2d").drawImage(a.img,0,0,1024,768),e=a.canvas[0].toDataURL("image/jpeg",.7).substr(23),a.imgItem.formData.push(e)}})}]});