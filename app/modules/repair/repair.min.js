"use strict";angular.module("app").controller("app.repair",["$scope","$timeout","$ionicModal","$api","User",function(e,t,n,a,i){var r=this,o={count:0,pageindex:0,pagesize:30};r.loadList=function(n){/refresher/.test(n)&&(o.count=0,o.pageindex=0),a.workorder.info({uid:i.data.uid,project:i.data.project,pageindex:o.pageindex+1,pagesize:o.pagesize},function(e){/refresher/.test(n)&&r.list&&(r.list.length=0),o=e.result.paging,angular.forEach(e.result.detail,function(e){this.push(e)},r.list=r.list||[])},function(){r.list?r.list.length=0:r.list=[]}).$promise.finally(function(){/refresher/.test(n)&&e.$broadcast("scroll.refreshComplete"),/infinite/.test(n)&&e.$broadcast("scroll.infiniteScrollComplete"),r.infiniteDisable=!0,r.list&&r.list.length<o.count&&t(function(){delete r.infiniteDisable},16.66)})},e.$on("$ionicView.enter",function(){n.fromTemplateUrl("app/modules/repair/detail.html?rev=3d690592c5",{scope:e,animation:"slide-in-up"}).then(function(e){r.modalDetail=e})}),e.$on("$ionicView.leave",function(){r.modalDetail&&r.modalDetail.remove()}),e.$on("modal.hidden",function(){delete r.selected})}]).component("repairDetail",{bindings:{selected:"<"},templateUrl:"tmpl-repair-detail.html",controller:["$q","$api","User","Upload","base64",function(e,t,n,a,i){var r=this;angular.extend(r,{content:{repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},picker:function(){window.ImagePicker.getPictures(function(e){alert("success:"+e)},function(e){alert("error:"+e)},{maximumImagesCount:3,quality:75})},upload:function(){var n=[];angular.forEach(r.content.repairImgs,function(r){if(angular.isUndefined(r.key)&&angular.isUndefined(r.$upload)){r.$upload=1;var o=e.defer();n.push(o.promise),a.base64DataUrl(r).then(function(e){r.__proto__.$base64=1,t.interaction.uploadtoken({file:(new Date).getTime()+"_"+r.name},function(n){t.qiniu.upload({base64:i.encode(n.result.file),token:n.result.token},{file:e.split("data:image/jpeg;base64,")[1]},function(e){r.key=e.key,angular.forEach(r,function(e,t){/^\$/.test(t)&&delete r[t]}),o.resolve(e)},o.reject)},o.reject)},o.reject)}}),e.all(n).then(function(){})},submit:function(){t.workorder.add({from:n.data.uid,content:r.content,project:n.data.project,type:1081},function(){})},$onChanges:function(e){r.data=e.selected.currentValue}})}]}).component("repairAdd",{templateUrl:"app/modules/repair/detail.html?rev=3d690592c5",controller:["$api","User","$state","$q","FileUploader","base64",function(e,t,n,a,i,r){var o=this;angular.extend(o,{$onInit:function(){o.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},o.submitted=!1,o.uploader=new i,o.uploader.queueLimit=3},removeItem:function(e){o.uploader.removeFromQueue(e)},submit:function(i){o.submitted=!0;var l=[];angular.forEach(o.uploader.queue,function(t){var n=(new Date).getTime()+"_"+t._file.name,i=a.defer();l.push(i.promise),o.data.repairImgs.push(n),e.interaction.uploadtoken({file:n},function(n){e.qiniu.put({base64:r.encode(n.result.file),token:n.result.token},{file:t.formData[0]},i.resolve,i.reject)},i.reject)}),a.all(l).then(function(){e.workorder.add({from:t.data.uid,content:o.data,project:t.data.project,type:1081},function(){Dialog.alert({title:"提交成功！",targrtEvent:i}),n.go("app.repair")},function(e){Dialog.alert({title:"提交失败！",textContent:e.message||void 0,targrtEvent:i})})},function(){Dialog.alert({title:"上传失败，请稍后再试",targrtEvent:i}),o.submitted=!1})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(e,t){var n=this;angular.extend(n,{$onInit:function(){n.helper={support:!(!e.FileReader||!e.CanvasRenderingContext2D),isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(t)}},n.helper.isFile(n.imgItem._file)&&n.helper.isImage(n.imgItem._file)&&(n.canvas=t.find("canvas"),n.reader=new FileReader,n.reader.onload=n.onLoadFile,n.reader.readAsDataURL(n.imgItem._file))},onLoadFile:function(e){n.img=new Image,n.img.onload=n.onLoadImage,n.img.src=e.target.result},onLoadImage:function(){n.compressedImg();var e=document.documentElement.clientWidth,t=.3*e>200?200:.3*e,a=t;n.canvas.attr({width:t,height:a}),n.canvas[0].getContext("2d").drawImage(this,0,0,t,a)},compressedImg:function(){var e;n.canvas.attr({width:1024,height:768}),n.canvas[0].getContext("2d").drawImage(n.img,0,0,1024,768),e=n.canvas[0].toDataURL("image/jpeg",.7).substr(23),n.imgItem.formData.push(e)}})}]});