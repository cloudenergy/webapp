"use strict";angular.module("app").controller("app.repair",["$scope","$timeout","$api","User",function(e,a,i,n){var r=this,o={count:0,pageindex:0,pagesize:30};r.loadList=function(t){/refresher/.test(t)&&(o.count=0,o.pageindex=0),i.workorder.info({uid:n.data.uid,project:n.data.project,pageindex:o.pageindex+1,pagesize:o.pagesize},function(e){/refresher/.test(t)&&r.list&&(r.list.length=0),o=e.result.paging,angular.forEach(e.result.detail,function(e){this.push(e)},r.list=r.list||[])},function(){r.list?r.list.length=0:r.list=[]}).$promise.finally(function(){/refresher/.test(t)&&e.$broadcast("scroll.refreshComplete"),/infinite/.test(t)&&e.$broadcast("scroll.infiniteScrollComplete"),r.infiniteDisable=!0,r.list&&r.list.length<o.count&&a(function(){delete r.infiniteDisable},16.66)})}}]).component("repairAdd",{templateUrl:"app/modules/repair/detail.html?rev=39a65bcdb9",controller:["$api","User","$state","$q","FileUploader","base64",function(n,e,a,r,t,o){var l=this;angular.extend(l,{$onInit:function(){l.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},l.submitted=!1,l.uploader=new t,l.uploader.queueLimit=3},removeItem:function(e){l.uploader.removeFromQueue(e)},submit:function(t){l.submitted=!0;var i=[];angular.forEach(l.uploader.queue,function(t){var e=(new Date).getTime()+"_"+t._file.name,a=r.defer();i.push(a.promise),l.data.repairImgs.push(e),n.interaction.uploadtoken({file:e},function(e){n.qiniu.put({base64:o.encode(e.result.file),token:e.result.token},{file:t.formData[0]},a.resolve,a.reject)},a.reject)}),r.all(i).then(function(){n.workorder.add({from:e.data.uid,content:l.data,project:e.data.project,type:1081},function(){Dialog.alert({title:"提交成功！",targrtEvent:t}),a.go("app.repair")},function(e){Dialog.alert({title:"提交失败！",textContent:e.message||void 0,targrtEvent:t})})},function(){Dialog.alert({title:"上传失败，请稍后再试",targrtEvent:t}),l.submitted=!1})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(t,e){var i=this;angular.extend(i,{$onInit:function(){i.helper={support:!(!t.FileReader||!t.CanvasRenderingContext2D),isFile:function(e){return angular.isObject(e)&&e instanceof t.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(t)}},i.helper.isFile(i.imgItem._file)&&i.helper.isImage(i.imgItem._file)&&(i.canvas=e.find("canvas"),i.reader=new FileReader,i.reader.onload=i.onLoadFile,i.reader.readAsDataURL(i.imgItem._file))},onLoadFile:function(e){i.img=new Image,i.img.onload=i.onLoadImage,i.img.src=e.target.result},onLoadImage:function(){i.compressedImg();var e=document.documentElement.clientWidth,t=200<.3*e?200:.3*e,a=t;i.canvas.attr({width:t,height:a}),i.canvas[0].getContext("2d").drawImage(this,0,0,t,a)},compressedImg:function(){var e;i.canvas.attr({width:1024,height:768}),i.canvas[0].getContext("2d").drawImage(i.img,0,0,1024,768),e=i.canvas[0].toDataURL("image/jpeg",.7).substr(23),i.imgItem.formData.push(e)}})}]});