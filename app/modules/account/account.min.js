"use strict";angular.module("app").controller("app.account",["$scope","$cookies","$ionicModal","$ionicLoading","$ionicActionSheet","$state","$storage","$api","User","ERRORCODE",function(e,a,t,i,o,n,r,d,s,l){var c=this;c.isWECHAT=window.isWECHAT,c.Items=[{key:"uid",label:"帐号",icon:"icon-app icon-account"},{key:"mobile",label:"手机号码",icon:"icon-app icon-phone",edit:"mobile"},{key:"email",label:"电子邮箱",icon:"icon-app icon-email",edit:"email"},{key:"numberOfSensor",label:"仪表数量",icon:"icon-app icon-energy",state:"app.device"},{key:"department",label:"商铺名称",icon:"icon-app icon-department",edit:"department"},{key:"tag",label:"商铺编号",icon:"icon-app icon-number"},{key:"area",label:"商铺面积",icon:"icon-app icon-area"},{key:"timecreate",label:"入住时间",icon:"icon-app icon-calendar"},{key:"numberOfDays",label:"运营天数",icon:"icon-app icon-days"}],c.stateGo=function(e,a){n.go(e,a||{})},(c.refresh=function(a){s.$userinfo({_inprogress:a}).then(function(){c.userdata=angular.copy(s.data),c.userdata.area=(c.userdata.area||0)+" ㎡",c.userdata.timecreate=c.userdata.timecreate&&moment(1e3*c.userdata.timecreate).format("YYYY-MM-DD")}).finally(function(){angular.isDefined(a)&&e.$broadcast("scroll.refreshComplete")})})(),e.$on("$ionicView.enter",function(){c.userdata&&c.refresh()}),c.itemClick=function(e){e.edit?c.departmentEdit(e.edit):e.state&&n.go(e.state,e.params||{})},c.actionSheet=function(e,t){o.show({cancelText:'<span class="padding-left padding-right">取消</span>',destructiveText:'<span class="padding-left padding-right">确认'+t+"</span>",destructiveButtonClicked:function(){if("unbind"===e){var t={openid:a.get("openid"),platformid:a.get("platformid")};d.account.unbind(angular.extend(t,{uid:r.get("uid")}),function(){Object.keys(t).map(function(e){a.remove(e,{path:"/",domain:".cloudenergy.me"})}),s.$logout().then(function(){alert(r.get("token")),n.go("app.bind",t)})})}"logout"===e&&s.$logout().then(function(){n.go("app.login",{},{location:"replace"})})}})},c.departmentEdit=function(e){c.editItem={action:e,value:angular.copy(s.data[e]),label:{email:"电子邮箱",mobile:"手机号码",department:"商铺名称"}[e],input:{type:{email:"email"}[e]||"text",required:{mobile:!0,department:!0}[e],maxlength:{mobile:11,department:30}[e]||50,pattern:{mobile:"^1[3,5-8]\\d{9}$"}[e]||".*"}},c.modalEdit&&c.modalEdit.show()},c.departmentUpdate=function(e){if(e.$error.required)return i.show({template:'<i class="ion-android-alert"></i> 请填写'+c.editItem.label,duration:1e3});if(e.$error.email)return i.show({template:'<i class="ion-android-alert"></i> 电子邮箱格式不正确',duration:1e3});if(e.$error.pattern&&"mobile"===c.editItem.action)return i.show({template:'<i class="ion-android-alert"></i> 手机号码格式不正确<br/>正确格式如：13888888888',duration:2e3});var a={id:s.data.departmentid};"department"===c.editItem.action?a.title=c.editItem.value:a[c.editItem.action]=c.editItem.value,d.department.update(a,function(){c.modalEdit.hide(),i.show({template:'<i class="ion-ios-checkmark"></i> 已保存',duration:500}).then(function(){c.refresh()})},function(e){i.show({template:'<i class="ion-alert-circled"></i> '+(l[e.code]||e.message||"保存失败"),duration:2e3})})},c.passwordEdit=function(){c.password={},c.modalPassword&&c.modalPassword.show()},c.passwordUpdate=function(e){return e.oldpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写原密码',duration:1e3}):e.newpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写新密码',duration:1e3}):e.newpasswd.$error.minlength?i.show({template:'<i class="ion-android-alert"></i> 新密码长度不能少于6位',duration:1500}):e.confirmpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写确认密码',duration:1e3}):angular.equals(c.password.newpasswd,c.password.confirmpasswd)?void d.account.passwd({oldpasswd:c.password.oldpasswd,newpasswd:c.password.newpasswd},function(){c.modalPassword.hide(),i.show({template:'<i class="ion-ios-checkmark"></i> 修改成功',duration:500})},function(e){i.show({template:'<i class="ion-alert-circled"></i> '+(l[e.code]||e.message||"修改失败"),duration:2e3})}):i.show({template:'<i class="ion-android-alert"></i> 确认密码与新密码不一致',duration:1500})},t.fromTemplateUrl("app/modules/account/edit.html?rev=6aaf35d63f",{scope:e,animation:"slide-in-up"}).then(function(e){c.modalEdit=e}),t.fromTemplateUrl("app/modules/account/password.html?rev=5b15f04c25",{scope:e,animation:"slide-in-up"}).then(function(e){c.modalPassword=e}),e.$on("$destroy",function(){c.modalEdit&&c.modalEdit.remove(),c.modalPassword&&c.modalPassword.remove()})}]);