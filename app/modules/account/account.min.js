"use strict";angular.module("app").controller("app.account",["$scope","$cookies","$ionicModal","$ionicLoading","$ionicActionSheet","$state","$api","User","ERRORCODE",function(e,a,o,i,t,n,r,d,s){var l=this;l.Items=[{key:"uid",label:"帐号",icon:"icon-app icon-account",iconColor:"#03a9f4"},{key:"mobile",label:"手机号码",icon:"icon-app icon-phone",iconColor:"#03a9f4",edit:"mobile"},{key:"email",label:"电子邮箱",icon:"icon-app icon-email",iconColor:"#03a9f4",edit:"email"},{key:"numberOfSensor",label:"仪表数量",icon:"icon-app icon-energy",iconColor:"#4caf50",state:"app.device"},{key:"department",label:"商铺名称",icon:"icon-app icon-department",iconColor:"#ef6c00",edit:"department"},{key:"tag",label:"商铺编号",icon:"icon-app icon-number",iconColor:"#ff9800"},{key:"area",label:"商铺面积",icon:"icon-app icon-area",iconColor:"#ff9800"},{key:"timecreate",label:"入住时间",icon:"icon-app icon-calendar",iconColor:"#ff9800"},{key:"numberOfDays",label:"运营天数",icon:"icon-app icon-days",iconColor:"#ff9800"}],l.stateGo=function(e,a){n.go(e,a||{})},(l.refresh=function(a){d.$userinfo({_inprogress:a}).then(function(){l.userdata=angular.copy(d.data),l.userdata.area=(l.userdata.area||0)+" ㎡",l.userdata.timecreate=l.userdata.timecreate&&moment(1e3*l.userdata.timecreate).format("YYYY-MM-DD")}).finally(function(){angular.isDefined(a)&&e.$broadcast("scroll.refreshComplete")})})(),l.itemClick=function(e){e.edit?l.departmentEdit(e.edit):e.state&&n.go(e.state,e.params||{})},l.actionSheet=function(e,o){t.show({cancelText:'<span class="padding-left padding-right">取消</span>',destructiveText:'<span class="padding-left padding-right">确认'+o+"</span>",destructiveButtonClicked:function(){if("unbind"===e){var o={openid:a.get("openid"),platformid:a.get("platformid")};r.account.unbind(o,function(){d.$logout({redirect:"/"}).then(function(){n.go("app.bind",o)})})}"logout"===e&&d.$logout({redirect:"/"}).then(function(){n.prev={},n.go("app.login",{},{location:"replace"})})}})},l.departmentEdit=function(e){l.editItem={action:e,value:angular.copy(d.data[e]),label:{email:"电子邮箱",mobile:"手机号码",department:"商铺名称"}[e],input:{type:{email:"email"}[e]||"text",required:{mobile:!0,department:!0}[e],maxlength:{mobile:11,department:30}[e]||50,pattern:{mobile:"^1[3,5-8]\\d{9}$"}[e]||".*"}},l.modalEdit&&l.modalEdit.show()},l.departmentUpdate=function(e){if(e.$error.required)return i.show({template:'<i class="ion-android-alert"></i> 请填写'+l.editItem.label,duration:1e3});if(e.$error.email)return i.show({template:'<i class="ion-android-alert"></i> 电子邮箱格式不正确',duration:1e3});if(e.$error.pattern&&"mobile"===l.editItem.action)return i.show({template:'<i class="ion-android-alert"></i> 手机号码格式不正确<br/>正确格式如：13888888888',duration:2e3});var a={id:d.data.departmentid};"department"===l.editItem.action?a.title=l.editItem.value:a[l.editItem.action]=l.editItem.value,r.department.update(a,function(){l.modalEdit.hide(),i.show({template:'<i class="ion-ios-checkmark"></i> 已保存',duration:500}).then(function(){l.refresh()})},function(e){i.show({template:'<i class="ion-alert-circled"></i> '+(s[parseInt(e.code)]||e.message||"保存失败"),duration:2e3})})},l.passwordEdit=function(){l.password={},l.modalPassword&&l.modalPassword.show()},l.passwordUpdate=function(e){return e.oldpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写原密码',duration:1e3}):e.newpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写新密码',duration:1e3}):e.newpasswd.$error.minlength?i.show({template:'<i class="ion-android-alert"></i> 新密码长度不能少于6位',duration:1500}):e.confirmpasswd.$error.required?i.show({template:'<i class="ion-android-alert"></i> 请填写确认密码',duration:1e3}):angular.equals(l.password.newpasswd,l.password.confirmpasswd)?void r.account.passwd({oldpasswd:l.password.oldpasswd,newpasswd:l.password.newpasswd},function(){l.modalPassword.hide(),i.show({template:'<i class="ion-ios-checkmark"></i> 修改成功',duration:500})},function(e){i.show({template:'<i class="ion-alert-circled"></i> '+(s[parseInt(e.code)]||e.message||"修改失败"),duration:2e3})}):i.show({template:'<i class="ion-android-alert"></i> 确认密码与新密码不一致',duration:1500})},o.fromTemplateUrl("app/modules/account/edit.html?rev=d0e03458f2",{scope:e,animation:"slide-in-up"}).then(function(e){l.modalEdit=e}),o.fromTemplateUrl("app/modules/account/password.html?rev=c2d49897e0",{scope:e,animation:"slide-in-up"}).then(function(e){l.modalPassword=e}),e.$on("$destroy",function(){l.modalEdit&&l.modalEdit.remove(),l.modalPassword&&l.modalPassword.remove()})}]);