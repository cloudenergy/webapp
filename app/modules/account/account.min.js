"use strict";angular.module("app").controller("app.account",["$scope","$cookies","$ionicModal","$ionicHistory","$ionicLoading","$ionicActionSheet","$state","$storage","$api","User","ERRORCODE",function(e,a,o,i,t,n,r,d,s,l,c){var p=this;p.Items=[{key:"uid",label:"帐号",icon:"icon-app icon-account",iconColor:"#03a9f4"},{key:"mobile",label:"手机号码",icon:"icon-app icon-phone",iconColor:"#03a9f4",edit:"mobile"},{key:"email",label:"电子邮箱",icon:"icon-app icon-email",iconColor:"#03a9f4",edit:"email"},{key:"numberOfSensor",label:"仪表数量",icon:"icon-app icon-energy",iconColor:"#4caf50",state:"app.device"},{key:"department",label:"商铺名称",icon:"icon-app icon-department",iconColor:"#ef6c00",edit:"department"},{key:"tag",label:"商铺编号",icon:"icon-app icon-number",iconColor:"#ff9800"},{key:"area",label:"商铺面积",icon:"icon-app icon-area",iconColor:"#ff9800"},{key:"timecreate",label:"入住时间",icon:"icon-app icon-calendar",iconColor:"#ff9800"},{key:"numberOfDays",label:"运营天数",icon:"icon-app icon-days",iconColor:"#ff9800"}],p.stateGo=function(e,a){r.go(e,a||{})},(p.refresh=function(a){l.$userinfo({_inprogress:a}).then(function(){p.userdata=angular.copy(l.data),p.userdata.area=(p.userdata.area||0)+" ㎡",p.userdata.timecreate=p.userdata.timecreate&&moment(1e3*p.userdata.timecreate).format("YYYY-MM-DD")}).finally(function(){angular.isDefined(a)&&e.$broadcast("scroll.refreshComplete")})})(),p.itemClick=function(e){e.edit?p.departmentEdit(e.edit):e.state&&r.go(e.state,e.params||{})},p.actionSheet=function(e,o){n.show({cancelText:'<span class="padding-left padding-right">取消</span>',destructiveText:'<span class="padding-left padding-right">确认'+o+"</span>",destructiveButtonClicked:function(){if("unbind"===e){var o={openid:a.get("openid"),platformid:a.get("platformid")};s.account.unbind(angular.extend(o,{uid:d.get("uid")}),function(){l.$logout({redirect:"/"}).then(function(){i.clearHistory(),i.clearCache().then(function(){r.go("app.bind",o)})})})}"logout"===e&&l.$logout({redirect:"/"}).then(function(){i.clearHistory(),i.clearCache().then(function(){r.prev={},r.go("app.login",{},{location:"replace"})})})}})},p.departmentEdit=function(e){p.editItem={action:e,value:angular.copy(l.data[e]),label:{email:"电子邮箱",mobile:"手机号码",department:"商铺名称"}[e],input:{type:{email:"email"}[e]||"text",required:{mobile:!0,department:!0}[e],maxlength:{mobile:11,department:30}[e]||50,pattern:{mobile:"^1[3,5-8]\\d{9}$"}[e]||".*"}},p.modalEdit&&p.modalEdit.show()},p.departmentUpdate=function(e){if(e.$error.required)return t.show({template:'<i class="ion-android-alert"></i> 请填写'+p.editItem.label,duration:1e3});if(e.$error.email)return t.show({template:'<i class="ion-android-alert"></i> 电子邮箱格式不正确',duration:1e3});if(e.$error.pattern&&"mobile"===p.editItem.action)return t.show({template:'<i class="ion-android-alert"></i> 手机号码格式不正确<br/>正确格式如：13888888888',duration:2e3});var a={id:l.data.departmentid};"department"===p.editItem.action?a.title=p.editItem.value:a[p.editItem.action]=p.editItem.value,s.department.update(a,function(){p.modalEdit.hide(),t.show({template:'<i class="ion-ios-checkmark"></i> 已保存',duration:500}).then(function(){p.refresh()})},function(e){t.show({template:'<i class="ion-alert-circled"></i> '+(c[parseInt(e.code)]||e.message||"保存失败"),duration:2e3})})},p.passwordEdit=function(){p.password={},p.modalPassword&&p.modalPassword.show()},p.passwordUpdate=function(e){return e.oldpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写原密码',duration:1e3}):e.newpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写新密码',duration:1e3}):e.newpasswd.$error.minlength?t.show({template:'<i class="ion-android-alert"></i> 新密码长度不能少于6位',duration:1500}):e.confirmpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写确认密码',duration:1e3}):angular.equals(p.password.newpasswd,p.password.confirmpasswd)?void s.account.passwd({oldpasswd:p.password.oldpasswd,newpasswd:p.password.newpasswd},function(){p.modalPassword.hide(),t.show({template:'<i class="ion-ios-checkmark"></i> 修改成功',duration:500})},function(e){t.show({template:'<i class="ion-alert-circled"></i> '+(c[parseInt(e.code)]||e.message||"修改失败"),duration:2e3})}):t.show({template:'<i class="ion-android-alert"></i> 确认密码与新密码不一致',duration:1500})},o.fromTemplateUrl("app/modules/account/edit.html?rev=6aaf35d63f",{scope:e,animation:"slide-in-up"}).then(function(e){p.modalEdit=e}),o.fromTemplateUrl("app/modules/account/password.html?rev=0be9cdfb7f",{scope:e,animation:"slide-in-up"}).then(function(e){p.modalPassword=e}),e.$on("$destroy",function(){p.modalEdit&&p.modalEdit.remove(),p.modalPassword&&p.modalPassword.remove()})}]);