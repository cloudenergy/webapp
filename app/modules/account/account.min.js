"use strict";angular.module("app").controller("app.account",["$scope","$cookies","$ionicModal","$ionicLoading","$ionicActionSheet","$state","$storage","$api","User","ERRORCODE",function(e,a,i,t,o,n,r,d,s,l){var c=this;c.isWECHAT=window.isWECHAT,c.Items=[{key:"uid",label:"帐号",icon:"icon-app icon-account"},{key:"mobile",label:"手机号码",icon:"icon-app icon-phone",edit:"mobile"},{key:"email",label:"电子邮箱",icon:"icon-app icon-email",edit:"email"},{key:"numberOfSensor",label:"仪表数量",icon:"icon-app icon-energy",state:"app.device"},{key:"department",label:"商铺名称",icon:"icon-app icon-department",edit:"department"},{key:"tag",label:"商铺编号",icon:"icon-app icon-number"},{key:"area",label:"商铺面积",icon:"icon-app icon-area"},{key:"timecreate",label:"入住时间",icon:"icon-app icon-calendar"},{key:"numberOfDays",label:"运营天数",icon:"icon-app icon-days"}],c.stateGo=function(e,a){n.go(e,a||{})},(c.refresh=function(a){s.$userinfo({_inprogress:a}).then(function(){c.userdata=angular.copy(s.data),c.userdata.area=(c.userdata.area||0)+" ㎡",c.userdata.timecreate=c.userdata.timecreate&&moment(1e3*c.userdata.timecreate).format("YYYY-MM-DD")}).finally(function(){angular.isDefined(a)&&e.$broadcast("scroll.refreshComplete")})})(),e.$on("$ionicView.enter",function(){c.userdata&&c.refresh(),i.fromTemplateUrl("app/modules/account/edit.html?rev=2e47d3f581",{scope:e,animation:"slide-in-up"}).then(function(e){c.modalEdit=e}),i.fromTemplateUrl("app/modules/account/password.html?rev=671c451d20",{scope:e,animation:"slide-in-up"}).then(function(e){c.modalPassword=e})}),e.$on("$ionicView.leave",function(){c.modalEdit&&c.modalEdit.remove(),c.modalPassword&&c.modalPassword.remove()}),c.itemClick=function(e){e.edit?c.departmentEdit(e.edit):e.state&&n.go(e.state,e.params||{})},c.actionSheet=function(e,i){o.show({cancelText:'<span class="padding-left padding-right">取消</span>',destructiveText:'<span class="padding-left padding-right">确认'+i+"</span>",destructiveButtonClicked:function(){if("unbind"===e){var i={openid:a.get("openid"),platformid:a.get("platformid")};d.account.unbind(angular.extend(i,{uid:r.get("uid")}),function(){s.$logout().then(function(){n.go("app.bind",i,{location:"replace"})})})}"logout"===e&&s.$logout().then(function(){n.go("app.login",{},{location:"replace"})})}})},c.departmentEdit=function(e){c.editItem={action:e,value:angular.copy(s.data[e]),label:{email:"电子邮箱",mobile:"手机号码",department:"商铺名称"}[e],input:{type:{email:"email"}[e]||"text",required:{mobile:!0,department:!0}[e],maxlength:{mobile:11,department:30}[e]||50,pattern:{mobile:"^1[3,5-8]\\d{9}$"}[e]||".*"}},c.modalEdit&&c.modalEdit.show()},c.departmentUpdate=function(e){if(e.$error.required)return t.show({template:'<i class="ion-android-alert"></i> 请填写'+c.editItem.label,duration:2e3});if(e.$error.email)return t.show({template:'<i class="ion-android-alert"></i> 电子邮箱格式不正确',duration:2e3});if(e.$error.pattern&&"mobile"===c.editItem.action)return t.show({template:'<i class="ion-android-alert"></i> 手机号码格式不正确<div>正确格式如：13888888888</div>',duration:2e3});var a={id:s.data.departmentid};"department"===c.editItem.action?a.title=c.editItem.value:a[c.editItem.action]=c.editItem.value,d.department.update(a,function(){c.modalEdit.hide(),t.show({template:'<i class="ion-ios-checkmark"></i> 已保存',duration:2e3}).then(function(){c.refresh()})},function(e){t.show({template:'<i class="ion-alert-circled"></i> '+(l[e.code]||e.message||"保存失败"),duration:2e3})})},c.passwordEdit=function(){c.password={},c.modalPassword&&c.modalPassword.show()},c.passwordUpdate=function(e){return e.oldpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写原密码',duration:2e3}):e.newpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写新密码',duration:2e3}):e.newpasswd.$error.minlength?t.show({template:'<i class="ion-android-alert"></i> 新密码长度不能少于6位',duration:2e3}):e.confirmpasswd.$error.required?t.show({template:'<i class="ion-android-alert"></i> 请填写确认密码',duration:2e3}):angular.equals(c.password.newpasswd,c.password.confirmpasswd)?void d.account.passwd({oldpasswd:c.password.oldpasswd,newpasswd:c.password.newpasswd},function(){c.modalPassword.hide(),t.show({template:'<i class="ion-ios-checkmark"></i> 修改成功',duration:2e3})},function(e){t.show({template:'<i class="ion-alert-circled"></i> '+(l[e.code]||e.message||"修改失败"),duration:2e3})}):t.show({template:'<i class="ion-android-alert"></i> 确认密码与新密码不一致',duration:2e3})}}]);