"use strict";angular.module("app").controller("app.recharge_channel",["$scope","$q","$timeout","$ionicLoading","$ionicHistory","$state","$stateParams","$api","User","ERRORCODE",function(e,n,a,i,t,o,r,c,s,u){var l=this;l.amount=r.amount,l.channelChecked=void 0,e.$on("$ionicView.beforeEnter",function(){l.refresh()}),"hubofeng001"===s.data.uid&&e.$on("$ionicView.afterLeave",function(){delete l.errorMessage}),l.refresh=function(n){return c.payment.channelinfo({_inprogress:n,project:s.data.project,type:window.isWECHAT&&["wx_pub"]||(window.isAndroid||window.isIOS)&&["alipay","wx"]||["alipay_pc_direct","alipay_qr","alipay_wap","wx_pub_qr","wx_wap"],flow:"EARNING",app:window.isWECHAT?void 0:"ZFT"},function(e){l.channels=e.result,angular.forEach(l.channels,function(e){e.icon="icon-app icon-"+(/^alipay/.test(e.type)?"alipay calm":"wechat balanced")}),l.channelChecked=l.channelChecked||l.channels[0]&&l.channels[0].id||void 0}).$promise.finally(function(){angular.isDefined(n)&&e.$broadcast("scroll.refreshComplete")})},l.submit=function e(){if(!l.amount)return o.go("app.recharge");if(!l.channelChecked)return i.show({template:'<i class="ion-android-alert"></i> 未选择支付方式',duration:2e3});var r=n.defer(),p=window.pingpp||window.Pingpp;p?(l.submit=angular.noop,c.payment.charge({project:s.data.project,body:"租付通",subject:"租付通-账户充值",uid:s.data.uid,amount:l.amount,channelaccountid:l.channelChecked},function(n){l.submit=e,p.createPayment(n.result,function(e,n){"success"===e?r.resolve():(r.reject(u["pingpp_"+e]),"hubofeng001"===s.data.uid&&(l.errorMessage="result："+e+" | error："+(angular.isObject(n)?JSON.stringify(n):n)))})},function(n){l.submit=e,r.reject(n.message)})):r.reject("请在手机APP或微信中充值"),r.promise.then(function(){i.show({template:'<i class="ion-ios-checkmark"></i> 充值成功',duration:2e3}),a(function(){t.goBack()},1500)},function(e){i.show({template:'<i class="ion-alert-circled"></i> '+(e||"充值失败"),duration:3e3})})}}]);