"use strict";angular.module("app").controller("app.recharge_channel",["$scope","$q","$ionicLoading","$state","$stateParams","$api","User","ERRORCODE",function(e,n,a,i,t,c,o,r){var s=this;s.amount=t.amount,s.channelChecked=void 0,e.$on("$ionicView.beforeEnter",function(){s.refresh()}),s.refresh=function(n){return c.payment.channelinfo({_inprogress:n,project:o.data.project,type:window.isWECHAT&&["wx_pub"]||(window.isAndroid||window.isIOS)&&["alipay","wx"]||["alipay_pc_direct","alipay_qr","alipay_wap","wx_pub_qr","wx_wap"],flow:"EARNING"},function(e){s.channels=e.result,angular.forEach(s.channels,function(e){e.icon="icon-app icon-"+(/^alipay/.test(e.type)?"alipay calm":"wechat balanced")}),s.channelChecked=s.channelChecked||s.channels[0]&&s.channels[0].id||void 0}).$promise.finally(function(){angular.isDefined(n)&&e.$broadcast("scroll.refreshComplete")})},s.submit=function(){if(!s.amount)return i.go("app.recharge");if(!s.channelChecked)return a.show({template:'<i class="ion-android-alert"></i> 暂无可用支付方式',duration:1e3});var e=n.defer(),t=window.pingpp||window.Pingpp;t?c.payment.charge({project:o.data.project,body:"智慧管家充值",subject:"智慧管家",uid:o.data.uid,amount:s.amount,channelaccountid:s.channelChecked},function(n){t.createPayment(n.result,function(n){"success"===n?e.resolve():e.reject(r["pingpp_"+n])})},function(n){e.reject(n.message)}):e.reject("请在手机APP或微信中充值"),e.promise.then(function(){s.refresh(void 0,!1).then(function(){a.show({template:'<i class="ion-ios-checkmark"></i> 充值成功',duration:1500})})},function(e){a.show({template:'<i class="ion-alert-circled"></i> '+(e||"充值失败"),duration:2e3})})}}]);