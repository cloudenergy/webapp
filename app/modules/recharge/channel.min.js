"use strict";angular.module("app").controller("app.recharge_channel",["$scope","$q","$timeout","$ionicLoading","$ionicHistory","$state","$stateParams","$api","User","ERRORCODE",function(n,e,a,i,t,c,o,r,s,l){var p=this;p.amount=o.amount,p.channelChecked=void 0,n.$on("$ionicView.beforeEnter",function(){p.refresh()}),p.refresh=function(e){return r.payment.channelinfo({_inprogress:e,project:s.data.project,type:window.isWECHAT&&["wx_pub"]||(window.isAndroid||window.isIOS)&&["alipay","wx"]||["alipay_pc_direct","alipay_qr","alipay_wap","wx_pub_qr","wx_wap"],flow:"EARNING",app:"ZFT"},function(n){p.channels=n.result,angular.forEach(p.channels,function(n){n.icon="icon-app icon-"+(/^alipay/.test(n.type)?"alipay calm":"wechat balanced")}),p.channelChecked=p.channelChecked||p.channels[0]&&p.channels[0].id||void 0}).$promise.finally(function(){angular.isDefined(e)&&n.$broadcast("scroll.refreshComplete")})},p.submit=function n(){if(!p.amount)return c.go("app.recharge");if(!p.channelChecked)return i.show({template:'<i class="ion-android-alert"></i> 暂无可用支付方式',duration:1e3});p.submit=function(){};var o=e.defer(),u=window.pingpp||window.Pingpp;u?r.payment.charge({project:s.data.project,body:"智慧管家充值",subject:"智慧管家",uid:s.data.uid,amount:p.amount,channelaccountid:p.channelChecked},function(n){u.createPayment(n.result,function(n){"success"===n?o.resolve():o.reject(l["pingpp_"+n])})},function(n){o.reject(n.message)}):o.reject("请在手机APP或微信中充值"),o.promise.then(function(){i.show({template:'<i class="ion-ios-checkmark"></i> 充值成功',duration:1500}),a(function(){t.goBack()},1500)},function(n){i.show({template:'<i class="ion-alert-circled"></i> '+(n||"充值失败"),duration:2e3})}).finally(function(){p.submit=n})}}]);