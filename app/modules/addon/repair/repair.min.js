"use strict";angular.module("app").component("addonRepair",{templateUrl:"app/modules/addon/repair/repair.html?rev=c96e41f6e6",controller:["$api","User",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.repairList=[],a.getRepairList()},getRepairList:function(){e.workorder.info({uid:t.data.uid,project:t.data.project},function(e){a.repairList=e.result},function(e){})}})}]}).component("addonRepairDetail",{templateUrl:"app/modules/addon/repair/repairdetail.html?rev=a6d2ea93f3",controller:["$api","User","$stateParams",function(e,t,a){var n=this;angular.extend(n,{$onInit:function(){e.workorder.info({id:a.id,project:t.data.project},function(e){n.data=e.result.content})}})}]}).component("addonRepairAdd",{templateUrl:"app/modules/addon/repair/repairdetail.html?rev=a6d2ea93f3",controller:["$api","User","$state","$q","Dialog","FileUploader","base64",function(e,t,a,n,r,i,o){var d=this;angular.extend(d,{$onInit:function(){d.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},d.submitted=!1,d.uploader=new i,d.uploader.queueLimit=3},removeItem:function(e){d.uploader.removeFromQueue(e)},submit:function(i){d.submitted=!0;var l=[];angular.forEach(d.uploader.queue,function(t){var a=(new Date).getTime()+"_"+t._file.name,r=n.defer();l.push(r.promise),d.data.repairImgs.push(a),e.interaction.uploadtoken({file:a},function(a){e.qiniu.put({base64:o.encode(a.result.file),token:a.result.token},{file:t.formData[0]},r.resolve,r.reject)},r.reject)}),n.all(l).then(function(){e.workorder.add({from:t.data.uid,content:d.data,project:t.data.project,type:1081},function(){r.alert({title:"提交成功！",targrtEvent:i}),a.go("app.addon.repair")})},function(){r.alert({title:"上传失败，请稍后再试",targrtEvent:i}),d.submitted=!1})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.helper={support:!(!e.FileReader||!e.CanvasRenderingContext2D),isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(t)!==-1}},a.helper.isFile(a.imgItem._file)&&a.helper.isImage(a.imgItem._file)&&(a.canvas=t.find("canvas"),a.reader=new FileReader,a.reader.onload=a.onLoadFile,a.reader.readAsDataURL(a.imgItem._file))},onLoadFile:function(e){a.img=new Image,a.img.onload=a.onLoadImage,a.img.src=e.target.result},onLoadImage:function(){a.compressedImg();var e=document.documentElement.clientWidth,t=.3*e>200?200:.3*e,n=t;a.canvas.attr({width:t,height:n}),a.canvas[0].getContext("2d").drawImage(this,0,0,t,n)},compressedImg:function(){var e,t=1024,n=768;a.canvas.attr({width:t,height:n}),a.canvas[0].getContext("2d").drawImage(a.img,0,0,t,n),e=a.canvas[0].toDataURL("image/jpeg",.7).substr(23),a.imgItem.formData.push(e)}})}]});