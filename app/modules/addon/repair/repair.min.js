"use strict";angular.module("app").component("addonRepair",{templateUrl:"app/modules/addon/repair/repair.html?rev=aedcf8f183",controller:["$api","$http","User","$state","$q","Dialog","FileUploader","base64",function(e,t,a,n,r,i,o,u){var d=this;angular.extend(d,{$onInit:function(){d.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},d.submitted=!1,d.uploader=new o,d.uploader.queueLimit=3},reqUptoken:function(t){var a=r.defer(),n=a.promise;return angular.forEach(d.uploader.queue,function(n){var o=(new Date).getTime()+"_"+n._file.name;d.data.repairImgs.push(o),e.interaction.uploadtoken({file:o},function(e){d.uploadToQiniu(n.formData[0],e.result.token,e.result.file,t).then(function(){r.all(t).then(function(e){a.resolve()})})},function(e){i.alert({title:"上传失败,请稍后再试"})})}),n},uploadToQiniu:function(e,a,n,i){var o=r.defer(),l=o.promise,p="http://upload.qiniu.com/putb64/-1/key/"+u.encode(n),m={method:"POST",url:p,headers:{"Content-Type":"application/octet-stream",Authorization:"UpToken "+a},data:e};return i.push(t(m)),i.length==d.uploader.queue.length&&o.resolve(),l},removeItem:function(e){d.uploader.removeFromQueue(e)},sendRepairmsg:function(){var t={from:a.data.uid,content:d.data,project:a.data.project,type:1081};e.workorder.add(t)},submit:function(e){d.submitted=!0;var t=[];d.reqUptoken(t).then(function(e){d.sendRepairmsg()}).then(function(){i.alert({title:"提交成功！",targrtEvent:e})}).then(function(){n.go("app.addon.index")})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.helper={support:!(!e.FileReader||!e.CanvasRenderingContext2D),isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(t)!==-1}},a.helper.isFile(a.imgItem._file)&&a.helper.isImage(a.imgItem._file)&&(a.canvas=t.find("canvas"),a.reader=new FileReader,a.reader.onload=a.onLoadFile,a.reader.readAsDataURL(a.imgItem._file))},onLoadFile:function(e){a.img=new Image,a.img.onload=a.onLoadImage,a.img.src=e.target.result},onLoadImage:function(){a.compressedImg();var e=100,t=100;a.canvas.attr({width:e,height:t}),a.canvas[0].getContext("2d").drawImage(this,0,0,e,t)},compressedImg:function(){var e,t=1024,n=768;a.canvas.attr({width:t,height:n}),a.canvas[0].getContext("2d").drawImage(a.img,0,0,t,n),e=a.canvas[0].toDataURL("image/jpeg",.7).substr(23),a.imgItem.formData.push(e)}})}]});