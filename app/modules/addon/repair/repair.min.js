"use strict";angular.module("app").component("addonRepair",{templateUrl:"app/modules/addon/repair/repair.html?rev=42e29ed928",controller:["$api","User",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.repairList=[],a.getRepairList()},getRepairList:function(){var n={uid:t.data.uid,project:t.data.project};e.workorder.info(n,function(e){a.repairList=e.result},function(e){})}})}]}).component("addonRepairDetail",{templateUrl:"app/modules/addon/repair/repairdetail.html?rev=e2e7fcd428",controller:["$stateParams",function(e){var t=this;angular.extend(t,{$onInit:function(){t.data=e.data,console.log(e)}})}]}).component("addonRepairAdd",{templateUrl:"app/modules/addon/repair/repairdetail.html?rev=e2e7fcd428",controller:["$api","$http","User","$state","$q","Dialog","FileUploader","base64",function(e,t,a,n,r,i,o,d){var l=this;angular.extend(l,{$onInit:function(){l.data={repairName:"",repairPlace:"",repairContent:"",repairPerson:"",repairPhone:"",repairImgs:[]},l.submitted=!1,l.uploader=new o,l.uploader.queueLimit=3},reqUptoken:function(t){var a=r.defer(),n=a.promise;return angular.forEach(l.uploader.queue,function(n){var o=(new Date).getTime()+"_"+n._file.name;l.data.repairImgs.push(o),e.interaction.uploadtoken({file:o},function(e){l.uploadToQiniu(n.formData[0],e.result.token,e.result.file,t).then(function(){r.all(t).then(function(e){a.resolve()})})},function(e){i.alert({title:"上传失败,请稍后再试"})})}),n},uploadToQiniu:function(e,a,n,i){var o=r.defer(),p=o.promise,u="/putb64/-1/key/"+d.encode(n),s={method:"POST",url:u,headers:{"Content-Type":"application/octet-stream",Authorization:"UpToken "+a},data:e};return i.push(t(s)),i.length==l.uploader.queue.length&&o.resolve(),p},removeItem:function(e){l.uploader.removeFromQueue(e)},sendRepairmsg:function(){var t={from:a.data.uid,content:l.data,project:a.data.project,type:1081};e.workorder.add(t)},submit:function(e){l.submitted=!0;var t=[];l.reqUptoken(t).then(function(e){l.sendRepairmsg()}).then(function(){i.alert({title:"提交成功！",targrtEvent:e})}).then(function(){n.go("app.addon.index")})}})}]}).component("imgThumb",{template:"<canvas></canvas>",bindings:{imgItem:"<"},controller:["$window","$element",function(e,t){var a=this;angular.extend(a,{$onInit:function(){a.helper={support:!(!e.FileReader||!e.CanvasRenderingContext2D),isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(t)!==-1}},a.helper.isFile(a.imgItem._file)&&a.helper.isImage(a.imgItem._file)&&(a.canvas=t.find("canvas"),a.reader=new FileReader,a.reader.onload=a.onLoadFile,a.reader.readAsDataURL(a.imgItem._file))},onLoadFile:function(e){a.img=new Image,a.img.onload=a.onLoadImage,a.img.src=e.target.result},onLoadImage:function(){a.compressedImg();var e=100,t=100;a.canvas.attr({width:e,height:t}),a.canvas[0].getContext("2d").drawImage(this,0,0,e,t)},compressedImg:function(){var e,t=1024,n=768;a.canvas.attr({width:t,height:n}),a.canvas[0].getContext("2d").drawImage(a.img,0,0,t,n),e=a.canvas[0].toDataURL("image/jpeg",.7).substr(23),a.imgItem.formData.push(e)}})}]});