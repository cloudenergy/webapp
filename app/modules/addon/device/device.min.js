"use strict";angular.module("app").component("addonDevice",{templateUrl:"app/modules/addon/device/device.html?rev=e2d2526a4d",controller:["$q","$api","User","Dialog",function(t,e,n,a){var i=this;angular.extend(i,{$onInit:function(){e.device.type({project:n.data.project},function(t){i.types=t.result||[],i.typeChange(i.types.selected=i.types.length&&i.types[0].id||void 0)})},typeChange:function(t){i.paging={count:0,pageindex:0,pagesize:30,unload:!0},i.list=[],delete i.switchall,delete i.switchall_disabled,t&&i.loadList()},typeIcons:{ELECTRICITYMETER:"electricity",HOTWATERMETER:"hot-water",COLDWATERMETER:"cold-water",ENERGYMETER:"energy",TEMPERATURECONTROL:"temperature",TIMERMETER:"time"},paging:{count:0,pageindex:0,pagesize:30,unload:!0},list:[],loadList:function(){(i.paging.unload||i.list.length<i.paging.count&&!i.paging.loading)&&(delete i.paging.unload,i.paging.loading=!0,e.sensor.info({project:n.data.project,devicetype:i.types.selected,pageindex:i.paging.pageindex+1,pagesize:i.paging.pagesize},function(t){t.result&&(angular.forEach(t.result.detail||[],function(t){angular.forEach(t.command,function(e){t.command[e]=e}),t.status.switch="EMC_ON"===t.status.switch,i.list.push(t)}),i.switchall=!0,i.switchall_disabled=!0,angular.forEach(i.list,function(t){t.command.EMC_SWITCH&&delete i.switchall_disabled,t.status.switch||delete i.switchall}),i.paging=t.result.paging)}))},infiniteItems:{getItemAtIndex:function(t){return t===i.list.length-1&&i.loadList(),i.list[t]},getLength:function(){return i.list.length}},toggleSwitch:function(n,l){var s=t.defer();return a.prompt({title:(angular.isObject(n)?"":"批量")+(l&&"打开"||"关闭"),placeholder:"控制密码"}).then(function(t,c){t?(angular.isObject(n)?c=n.id:angular.forEach(i.list,function(t){t.command.EMC_SWITCH&&!l===t.status.switch&&this.push(t.id)},c=[]),e.control.send({id:c,command:"EMC_SWITCH",ctrlcode:(new Hashes.SHA1).hex(t).toUpperCase(),param:{mode:l&&"EMC_ON"||"EMC_OFF"}},function(){s.resolve(),a.alert({title:"操作成功"})},function(t){a.alert({title:"操作失败",textContent:t.message||"命令发送失败"}).then(s.reject)})):s.reject()},s.reject),s.promise.then(function(){angular.isObject(n)||angular.forEach(i.list,function(t){t.command.EMC_SWITCH&&(t.status.switch=i.switchall)})},function(){angular.isObject(n)?n.status.switch=!n.status.switch:i.switchall=!i.switchall}),s.promise}})}]});