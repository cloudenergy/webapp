"use strict";angular.module("app").controller("app.device",["$scope","$q","$timeout","$ionicScrollDelegate","$ionicPopover","$ionicPopup","$ionicLoading","$api","User","ERRORCODE",function(e,t,i,o,s,a,l,n,c,r){var p=this,d={ELECTRICITYMETER:"icon-app icon-electricity energized",HOTWATERMETER:"icon-app icon-hot-water assertive",COLDWATERMETER:"icon-app icon-cold-water calm",ENERGYMETER:"icon-app icon-energy positive",TEMPERATURECONTROL:"icon-app icon-temperature assertive",TIMERMETER:"icon-app icon-time balanced"},u={count:0,pageindex:0,pagesize:50},g=function(e){return p.types&&!/refresher/.test(e)?t.resolve():n.device.type({project:c.data.project},function(e){var t=p.types&&p.types.selected||{};angular.forEach(e.result,function(e){e.id===t.id&&(this.selected=e),this.push(e)},p.types=[]),p.types.selected=p.types.selected||p.types[0]}).$promise};p.loadList=function(t){/radio|refresher/.test(t)&&(p.toggleAll_Disabled=!0,delete p.toggleAll,u.count=0,u.pageindex=0),/radio/.test(t)&&(o.scrollTop(),o.resize(),p.list&&(p.list.length=0),u.count=0,u.pageindex=0),g(t).then(function(){n.business.monitor({mode:"SENSOR",project:c.data.project,devicetype:p.types.selected.id,pageindex:u.pageindex+1,pagesize:u.pagesize},function(e){/refresher/.test(t)&&p.list&&(p.list.length=0),u=e.result[c.data.project].paging,angular.forEach(e.result[c.data.project].detail,function(e){angular.forEach(e.command,function(t){e.command[t]=t}),e.status.switch="EMC_ON"===e.status.switch,e.icon=d[p.types.selected.id],this.push(e)},p.list=p.list||[]),p.toggleAll=!0,p.toggleAll_Disabled=!0,angular.forEach(p.list,function(e){e.command.EMC_SWITCH&&(delete p.toggleAll_Disabled,e.status.switch||delete p.toggleAll)})}).$promise.finally(function(){/refresher/.test(t)&&e.$broadcast("scroll.refreshComplete"),/infinite/.test(t)&&e.$broadcast("scroll.infiniteScrollComplete"),p.infiniteDisable=!0,p.list&&p.list.length<u.count&&i(function(){delete p.infiniteDisable},16.66)})})},p.toggle_disabled=!1,p.toggleAll_Disabled=!0,p.toggleChange=function(e,t){p.toggle_disabled=!0;var i=a.prompt({title:["<b>"+(angular.isObject(e)&&e.title||"批量控制")+"</b>",'<div class="padding-top positive">[ '+(t&&"打开"||"关闭")+" ]</div>"].join(""),inputPlaceholder:"请输入控制密码",inputType:"password",maxLength:50,buttons:[{text:"取消",onTap:function(){p.toggle_disabled=!1,angular.isObject(e)?e.status.switch=!e.status.switch:p.toggleAll=!p.toggleAll}},{text:"<b>确定</b>",type:"button-positive",onTap:function(o){o.preventDefault();var s=this.scope,a=[];s.data.response?(angular.isObject(e)?a.push(e.id):angular.forEach(p.list,function(e){e.command.EMC_SWITCH&&angular.equals(!t,e.status.switch)&&this.push(e.id)},a),a.length?(s.buttons[1].text="提交中...",n.control.send({id:a,project:c.data.project,command:"EMC_SWITCH",ctrlcode:(new window.Hashes.SHA1).hex(s.data.response).toUpperCase(),param:{mode:t&&"EMC_ON"||"EMC_OFF"}},function(){i.close(),p.toggle_disabled=!1,angular.isObject(e)?(p.toggleAll=!0,angular.forEach(p.list,function(e){e.command.EMC_SWITCH&&!e.status.switch&&delete p.toggleAll})):angular.forEach(p.list,function(e){e.command.EMC_SWITCH&&angular.equals(!t,e.status.switch)&&(e.status.switch=p.toggleAll)})},function(e){s.buttons[1].text="<b>确定</b>",l.show({template:'<i class="ion-alert-circled"></i> '+(r[parseInt(e.code)]||e.message||"操作失败"),duration:1e3})})):(i.close(),l.show({template:'<i class="ion-android-alert"></i> 没有可操作项',duration:1e3}))):l.show({template:'<i class="ion-android-alert"></i> 请输入控制密码',duration:1e3})}}]})},s.fromTemplateUrl("device-popover-device-type.html",{scope:e}).then(function(e){p.popover=e}),e.$on("$destroy",function(){p.popover.remove()})}]);