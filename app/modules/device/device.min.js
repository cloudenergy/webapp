"use strict";angular.module("app").controller("app.device",["$scope","$q","$timeout","$ionicScrollDelegate","$ionicPopover","$ionicPopup","$ionicLoading","$api","User","ERRORCODE",function(e,t,i,o,s,n,l,a,r,c){var d=this,p={count:0,pageindex:0,pagesize:50},u=function(e){return d.types&&!/refresher/.test(e)?t.resolve():a.device.type({_inprogress:!/infinite|refresher/.test(e)&&void 0,project:r.data.project},function(e){var t=d.types&&d.types.selected||{};angular.forEach(e.result,function(e){e.id===t.id&&(this.selected=e),this.push(e)},d.types=[]),d.types.selected=d.types.selected||d.types[0]}).$promise};e.$on("$ionicView.enter",function(){d.list&&d.loadList("radio")}),d.toggle_disabled=!1,d.toggleAll_Hide=!0,d.loadList=function(t){/radio|refresher/.test(t)&&(p.count=0,p.pageindex=0),/radio/.test(t)&&(o.scrollTop(),o.resize(),p.count=0,p.pageindex=0),u(t).then(function(){a.business.monitor({_inprogress:!/infinite|refresher/.test(t)&&void 0,mode:"SENSOR",project:r.data.project,devicetype:d.types.selected.id,pageindex:p.pageindex+1,pagesize:p.pagesize},function(e){/radio|refresher/.test(t)&&d.list&&(d.list.length=0),p=e.result[r.data.project].paging,angular.forEach(e.result[r.data.project].detail,function(e){angular.forEach(e.command,function(t){e.command[t]=t}),e.status.switch="EMC_ON"===e.status.switch,this.push(e)},d.list=d.list||[]),d.toggleAll=!0,d.toggleAll_Hide=!0,angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&(delete d.toggleAll_Hide,e.status.switch||delete d.toggleAll)})},function(){d.list&&(d.list.length=0),d.toggleAll_Hide=!0,delete d.toggleAll}).$promise.finally(function(){/refresher/.test(t)&&e.$broadcast("scroll.refreshComplete"),/infinite/.test(t)&&e.$broadcast("scroll.infiniteScrollComplete"),d.infiniteDisable=!0,d.list&&d.list.length<p.count&&i(function(){delete d.infiniteDisable},16.66)})})},d.toggleChange=function(e,t){d.toggle_disabled=!0;var i=n.prompt({title:["<b>"+(angular.isObject(e)&&e.title||"批量控制")+"</b>",'<div class="padding-top positive">[ '+(t&&"打开"||"关闭")+" ]</div>"].join(""),inputPlaceholder:"请输入控制密码",inputType:"password",maxLength:50,buttons:[{text:"取消",onTap:function(){d.toggle_disabled=!1,angular.isObject(e)?e.status.switch=!e.status.switch:d.toggleAll=!d.toggleAll}},{text:"<b>确定</b>",type:"button-positive",onTap:function(o){o.preventDefault();var s=this.scope,n=[];s.data.response?(angular.isObject(e)?n.push(e.id):angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&angular.equals(!t,e.status.switch)&&this.push(e.id)},n),n.length?(s.buttons[1].text="提交中...",a.control.send({id:n,project:r.data.project,command:"EMC_SWITCH",ctrlcode:(new window.Hashes.SHA1).hex(s.data.response).toUpperCase(),param:{mode:t&&"EMC_ON"||"EMC_OFF"}},function(){i.close(),d.toggle_disabled=!1,angular.isObject(e)?(d.toggleAll=!0,angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&!e.status.switch&&delete d.toggleAll})):angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&angular.equals(!t,e.status.switch)&&(e.status.switch=d.toggleAll)})},function(e){s.buttons[1].text="<b>确定</b>",l.show({template:'<i class="ion-alert-circled"></i> '+(c[e.code]||e.message||"操作失败"),duration:2e3})})):(i.close(),l.show({template:'<i class="ion-android-alert"></i> 没有可操作项',duration:2e3}))):l.show({template:'<i class="ion-android-alert"></i> 请输入控制密码',duration:2e3})}}]})},s.fromTemplateUrl("device-popover-device-type.html",{scope:e}).then(function(e){d.popover=e}),e.$on("$destroy",function(){d.popover.remove()})}]);