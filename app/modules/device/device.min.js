"use strict";angular.module("app").controller("app.device",["$scope","$q","$timeout","$ionicScrollDelegate","$ionicPopover","$ionicPopup","$ionicLoading","$api","User","ERRORCODE",function(i,o,s,l,e,t,n,a,r,c){var d=this,p={count:0,pageindex:0,pagesize:50};i.$on("$ionicView.enter",function(){d.list&&d.loadList("radio"),e.fromTemplateUrl("device-popover-device-type.html",{scope:i}).then(function(e){d.popover=e})}),i.$on("$ionicView.leave",function(){d.popover&&d.popover.remove()}),d.toggle_disabled=!1,d.toggleAll_Hide=!0,d.loadList=function(t){var e;/radio|refresher/.test(t)&&(p.count=0,p.pageindex=0),/radio/.test(t)&&(l.scrollTop(),l.resize(),p.count=0,p.pageindex=0),(e=t,d.types&&!/refresher/.test(e)?o.resolve():a.device.type({_inprogress:!/infinite|refresher/.test(e)&&void 0,project:r.data.project},function(e){var t=d.types&&d.types.selected||{};angular.forEach(e.result,function(e){e.id===t.id&&(this.selected=e),this.push(e)},d.types=[]),d.types.selected=d.types.selected||d.types[0]}).$promise).then(function(){a.business.monitor({_inprogress:!/infinite|refresher/.test(t)&&void 0,mode:"SENSOR",project:r.data.project,devicetype:d.types.selected.id,pageindex:p.pageindex+1,pagesize:p.pagesize},function(e){/radio|refresher/.test(t)&&d.list&&(d.list.length=0),p=e.result[r.data.project].paging,angular.forEach(e.result[r.data.project].detail,function(t){angular.forEach(t.command,function(e){t.command[e]=e}),t.status.switch="EMC_ON"===t.status.switch,this.push(t)},d.list=d.list||[]),d.toggleAll=!0,d.toggleAll_Hide=!0,angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&(delete d.toggleAll_Hide,e.status.switch||delete d.toggleAll)})},function(){d.list?d.list.length=0:d.list=[],d.toggleAll_Hide=!0,delete d.toggleAll}).$promise.finally(function(){/refresher/.test(t)&&i.$broadcast("scroll.refreshComplete"),/infinite/.test(t)&&i.$broadcast("scroll.infiniteScrollComplete"),d.infiniteDisable=!0,d.list&&d.list.length<p.count&&s(function(){delete d.infiniteDisable},16.66)})})},d.toggleChange=function(o,s){d.toggle_disabled=!0;var l=t.prompt({title:["<b>"+(angular.isObject(o)&&o.title||"批量控制")+"</b>",'<div class="padding-top positive">[ '+(s?"打开":"关闭")+" ]</div>"].join(""),inputPlaceholder:"请输入控制密码",inputType:"password",maxLength:50,buttons:[{text:"取消",onTap:function(){d.toggle_disabled=!1,angular.isObject(o)?o.status.switch=!o.status.switch:d.toggleAll=!d.toggleAll}},{text:"<b>确定</b>",type:"button-positive",onTap:function(e){e.preventDefault();var t=this.scope,i=[];t.data.response?(angular.isObject(o)?i.push(o.id):angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&angular.equals(!s,e.status.switch)&&this.push(e.id)},i),i.length?(t.buttons[1].text="提交中...",a.control.send({id:i,project:r.data.project,command:"EMC_SWITCH",ctrlcode:(new window.Hashes.SHA1).hex(t.data.response).toUpperCase(),param:{mode:s?"EMC_ON":"EMC_OFF"}},function(){l.close(),d.toggle_disabled=!1,angular.isObject(o)?(d.toggleAll=!0,angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&!e.status.switch&&delete d.toggleAll})):angular.forEach(d.list,function(e){e.command.EMC_SWITCH&&angular.equals(!s,e.status.switch)&&(e.status.switch=d.toggleAll)})},function(e){t.buttons[1].text="<b>确定</b>",n.show({template:'<i class="ion-alert-circled"></i> '+(c[e.code]||e.message||"操作失败"),duration:2e3})})):(l.close(),n.show({template:'<i class="ion-android-alert"></i> 没有可操作项',duration:2e3}))):n.show({template:'<i class="ion-android-alert"></i> 请输入控制密码',duration:2e3})}}]})}}]);