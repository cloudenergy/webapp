"use strict";angular.module("app").constant("APICONFIG",{auth:["auth",,{login:{},logout:{}}],account:["account",,{passwd:{},unbind:{url:"wxaccount/unbind"},wxbind:{url:"wxaccount/bind"}}],apptemplate:["apptemplate",,{info:{}}],business:["business",,{userinfo:{},recentchargelog:{},fundflow:{},monitor:{},timequantumstatistic:{}}],device:["device",,{type:{}}],payment:["payment",,{channelinfo:{},charge:{}}],control:["control",,{send:{}}],department:["department",,{update:{}}],message:["message",,{list:{},readed:{},delete:{}}],workorder:["workorder",,{add:{},info:{}}],interaction:["interaction",,{uploadtoken:{}}],qiniu:["qiniu",,{upload:{url:window.APIORIGIN+"/putb64/-1/key/:base64",transformRequest:function(e){return e.file},headers:{"Content-Type":"application/octet-stream",Authorization:function(e){if(e.params&&e.params.token){var n="UpToken "+e.params.token;return delete e.params.token,n}}}}}]}).service("$api",["$rootScope","$resource","APICONFIG",function(e,n,t){var i=function(e,n){return/(^http:\/\/)|(^https:\/\/)/.test(e)&&e||[window.APIORIGIN+"/api/"+e,n?"/:_api_action":""].join("")},r=[];e.$on("$stateChangeStart",function(){angular.forEach(r,function(e){!e.$resolved&&e.$cancelRequest()}),r=[]}),angular.forEach(t,function(t,e){angular.isArray(t)&&t[0]&&(t[0]=i(t[0],!!t[2]),t[3]=angular.extend({cancellable:!0},t[3]),angular.forEach(t[2],function(e,n){e.url=e.url&&i(e.url)||void 0,e.method=e.method||"POST",e.params=e.params||{},e.params._api_action=e.url?void 0:n,window.isPRODUCTION||(e.headers=e.headers||{},e.headers["X-Cors-By"]="cloudenergy.me"),/api\.cloudenergy\.me/.test(e.url||t[0])&&angular.isUndefined(e.withCredentials)&&(e.withCredentials=!0)}),angular.forEach(this[e]=n.apply(n,t),function(t,e){this[e]=function(){var e,n;return angular.forEach([arguments[0],arguments[1]],function(e){angular.isObject(e)&&angular.isDefined(e._cancellable)&&(n=e._cancellable,delete e._cancellable)}),e=t.apply(this,arguments),!1===n&&delete e.$cancelRequest,e.$cancelRequest&&r.push(e),e}},this[e]))},this)}]).service("$loading",["$rootScope","$timeout",function(n,t){var i=this;angular.extend(i,{activities:0,inprogress:0,show:function(e){angular.isObject(e.params)&&(e._inprogress=e.params._inprogress,delete e.params._inprogress),angular.isObject(e.data)&&angular.isUndefined(e._inprogress)&&(e._inprogress=e.data._inprogress,delete e.data._inprogress),window.NetworkActivityIndicator&&(e._activities=t(function(){i.activities++,e._activities=i.activities,1===i.activities&&window.NetworkActivityIndicator.show()},60)),n.User.data&&(window.isPRODUCTION||window.isAndroid)&&!1!==e._inprogress&&(e._inprogress=t(function(){i.inprogress++,e._inprogress=i.inprogress,1===i.inprogress&&n.$broadcast("loading:show")},600))},hide:function(e){window.NetworkActivityIndicator&&(angular.isNumber(e._activities)?t(function(){i.activities--,0===i.activities&&window.NetworkActivityIndicator.hide()},600):angular.isObject(e._activities)&&t.cancel(e._activities),delete e._activities),(window.isPRODUCTION||window.isAndroid)&&!1!==e._inprogress&&(angular.isNumber(e._inprogress)?t(function(){i.inprogress--,0===i.inprogress&&n.$broadcast("loading:hide")},600):angular.isObject(e._inprogress)&&t.cancel(e._inprogress)),delete e._inprogress}})}]).config(["$qProvider","$httpProvider",function(e,n){e.errorOnUnhandledRejections(!1),n.interceptors.push(["$q","$location","$loading","$storage",function(n,t,i,r){return{request:function(e){return i.show(e),window.isPRODUCTION||!/\/api\//.test(e.url)||/\/api\/auth\/(login|logout)/.test(e.url)||(e.transformRequest=e.transformRequest.concat([function(e){return JSON.stringify(r.encrypt(JSON.parse(e||"{}")))}])),e},requestError:function(e){return n.reject(e)},response:function(e){return e.config&&i.hide(e.config),angular.isObject(e.data)&&(e.data.code||e.data.result&&angular.isObject(e.data.result)&&!Object.keys(e.data.result).length)?(/90000005|90000007/.test(e.data.code)&&t.url(window.isWECHAT?"/m/bind":"/m/login").replace(),n.reject(e.data)):e},responseError:function(e){return e.config&&i.hide(e.config),n.reject(e.data||{code:e.status})}}}])}]).run(["$rootScope","$ionicLoading",function(e,n){e.$on("loading:show",function(){n.show({template:'<ion-spinner icon="ripple" class="spinner-stable"></ion-spinner>',noBackdrop:!0})}),e.$on("loading:hide",function(){n.hide()})}]);