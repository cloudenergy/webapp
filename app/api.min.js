"use strict";angular.module("app").constant("APICONFIG",{auth:["auth",,{login:{},logout:{}}],account:["account",,{passwd:{},unbind:{url:"wxaccount/unbind"},wxbind:{url:"wxaccount/bind"}}],apptemplate:["apptemplate",,{info:{}}],business:["business",,{userinfo:{},recentchargelog:{},fundflow:{},monitor:{},timequantumstatistic:{}}],device:["device",,{type:{}}],payment:["payment",,{channelinfo:{},charge:{}}],control:["control",,{send:{}}],department:["department",,{update:{}}],message:["message",,{list:{},readed:{},delete:{}}],workorder:["workorder",,{add:{},info:{}}],interaction:["interaction",,{uploadtoken:{}}],qiniu:["qiniu",,{upload:{url:window.APIORIGIN+"/putb64/-1/key/:base64",transformRequest:function(e){return e.file},headers:{"Content-Type":"application/octet-stream",Authorization:function(e){if(e.params&&e.params.token){var n="UpToken "+e.params.token;return delete e.params.token,n}}}}}]}).service("$api",["$rootScope","$resource","APICONFIG",function(e,n,t){var i=function(e,n){return/(^http:\/\/)|(^https:\/\/)/.test(e)&&e||[window.APIORIGIN+"/api/"+e,n&&"/:_api_action"||""].join("")},r=[];e.$on("$stateChangeStart",function(){angular.forEach(r,function(e){!e.$resolved&&e.$cancelRequest()}),r=[]}),angular.forEach(t,function(e,t){angular.isArray(e)&&e[0]&&(e[0]=i(e[0],!!e[2]),e[3]=angular.extend({cancellable:!0},e[3]),angular.forEach(e[2],function(n,t){n.url=n.url&&i(n.url)||void 0,n.method=n.method||"POST",n.params=n.params||{},n.params._api_action=n.url?void 0:t,window.isPRODUCTION||(n.headers=n.headers||{},n.headers["X-Cors-By"]="cloudenergy.me"),/api\.cloudenergy\.me/.test(n.url||e[0])&&angular.isUndefined(n.withCredentials)&&(n.withCredentials=!0)}),angular.forEach(this[t]=n.apply(n,e),function(e,n){this[n]=function(){var n,t;return angular.forEach([arguments[0],arguments[1]],function(e){angular.isObject(e)&&angular.isDefined(e._cancellable)&&(t=e._cancellable,delete e._cancellable)}),n=e.apply(this,arguments),!1===t&&delete n.$cancelRequest,n.$cancelRequest&&r.push(n),n}},this[t]))},this)}]).service("$loading",["$rootScope","$timeout",function(e,n){var t=this;angular.extend(t,{activities:0,inprogress:0,show:function(i){angular.isObject(i.params)&&(i._inprogress=i.params._inprogress,delete i.params._inprogress),angular.isObject(i.data)&&angular.isUndefined(i._inprogress)&&(i._inprogress=i.data._inprogress,delete i.data._inprogress),window.NetworkActivityIndicator&&(i._activities=n(function(){t.activities++,i._activities=t.activities,1===t.activities&&window.NetworkActivityIndicator.show()},60)),e.User.data&&(window.isPRODUCTION||window.isAndroid)&&!1!==i._inprogress&&(i._inprogress=n(function(){t.inprogress++,i._inprogress=t.inprogress,1===t.inprogress&&e.$broadcast("loading:show")},600))},hide:function(i){window.NetworkActivityIndicator&&(angular.isNumber(i._activities)?n(function(){0===--t.activities&&window.NetworkActivityIndicator.hide()},600):angular.isObject(i._activities)&&n.cancel(i._activities),delete i._activities),(window.isPRODUCTION||window.isAndroid)&&!1!==i._inprogress&&(angular.isNumber(i._inprogress)?n(function(){0===--t.inprogress&&e.$broadcast("loading:hide")},600):angular.isObject(i._inprogress)&&n.cancel(i._inprogress)),delete i._inprogress}})}]).config(["$qProvider","$httpProvider",function(e,n){e.errorOnUnhandledRejections(!1),n.interceptors.push(["$q","$location","$loading","$storage",function(e,n,t,i){return{request:function(e){return t.show(e),window.isPRODUCTION||!/\/api\//.test(e.url)||/\/api\/auth\/(login|logout)/.test(e.url)||(e.transformRequest=e.transformRequest.concat([function(e){return JSON.stringify(i.encrypt(JSON.parse(e||"{}")))}])),e},requestError:function(n){return e.reject(n)},response:function(i){return i.config&&t.hide(i.config),angular.isObject(i.data)&&(i.data.code||i.data.result&&angular.isObject(i.data.result)&&!Object.keys(i.data.result).length)?(/90000005|90000007/.test(i.data.code)&&n.url(window.isWECHAT?"/m/bind":"/m/login").replace(),e.reject(i.data)):i},responseError:function(n){return n.config&&t.hide(n.config),e.reject(n.data||{code:n.status})}}}])}]).run(["$rootScope","$ionicLoading",function(e,n){e.$on("loading:show",function(){n.show({template:'<ion-spinner icon="ripple" class="spinner-stable"></ion-spinner>',noBackdrop:!0})}),e.$on("loading:hide",function(){n.hide()})}]);